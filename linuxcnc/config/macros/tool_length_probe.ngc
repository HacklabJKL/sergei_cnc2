o<tool_length_probe> sub

; Spindle must be stopped
M5

; Ensure we're in G90 / absolute mode
G90

G53 G0 Z#<_ini[TOOLSENSOR]Z>
G53 G0 X#<_ini[TOOLSENSOR]X> Y#<_ini[TOOLSENSOR]Y>

G38.3 Z[#<_z> + #<_ini[TOOLSENSOR]MAXPROBE>] F500

O1 if [#5070 EQ 1]
    ; Set new tool length
    G49
    G43.1 Z[#5063 - #<_ini[TOOLSENSOR]ZPOS>]
    
    ; Move off the sensor
    G53 G0 Z#<_ini[TOOLSENSOR]Z>
O1 else
    (MSG,Probe did not detect contact)
O1 endif

o<tool_length_probe> endsub
M2
